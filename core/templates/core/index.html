{% extends 'core/base.html' %}

{% block content %}
<div class="container mt-4">
  <h1 class="mb-4">Управление справочниками</h1>

  <!-- ==== Формы ==== -->
  <div class="row g-3 mb-5">
    <!-- Фабрика -->
    <div class="col-md-4">
      <div class="card shadow-sm">
        <div class="card-header">Новая фабрика</div>
        <div class="card-body">
          <form id="add-factory-form">
            {% csrf_token %}
            <div class="mb-3">
              <label class="form-label">Название фабрики</label>
              <input type="text" name="name" class="form-control" required>
            </div>
            <button type="submit" class="btn btn-primary w-100">Добавить</button>
          </form>
        </div>
      </div>
    </div>
    <!-- Участок -->
    <div class="col-md-4">
      <div class="card shadow-sm">
        <div class="card-header">Новый участок</div>
        <div class="card-body">
          <form id="add-unit-form">
            {% csrf_token %}
            <div class="mb-3">
              <label class="form-label">Название участка</label>
              <input type="text" name="name" class="form-control" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Фабрика</label>
              <select name="factory" class="form-select" required>
                <option value="">— выберите фабрику —</option>
                {% for f in factories %}
                  <option value="{{ f.id }}">{{ f.name }}</option>
                {% endfor %}
              </select>
            </div>
            <button type="submit" class="btn btn-primary w-100">Добавить</button>
          </form>
        </div>
      </div>
    </div>
    <!-- Оборудование -->
    <div class="col-md-4">
      <div class="card shadow-sm">
        <div class="card-header">Новое оборудование</div>
        <div class="card-body">
          <form id="add-equipment-form">
            {% csrf_token %}
            <div class="mb-3">
              <label class="form-label">Название оборудования</label>
              <input type="text" name="name" class="form-control" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Участки <small>(Ctrl+клик)</small></label>
              <select name="units" class="form-select" multiple size="4" required>
                {% for u in units %}
                  <option value="{{ u.id }}">{{ u.factory.name }} → {{ u.name }}</option>
                {% endfor %}
              </select>
            </div>
            <button type="submit" class="btn btn-primary w-100">Добавить</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- ==== Таблицы ==== -->
  <div class="row gy-4">
    <!-- Фабрики -->
    <div class="col-lg-4">
      <h3>Фабрики</h3>
      <table id="factories-table" class="table table-striped">
        <thead>
          <tr><th>ID</th><th>Название</th><th>Действия</th></tr>
        </thead>
        <tbody>
          {% for f in factories %}
            <tr>
              <td>{{ f.id }}</td>
              <td>{{ f.name }}</td>
              <td>
                <a href="{% url 'hierarchy' 'factory' f.id %}"
                   class="btn btn-sm btn-outline-primary">Иерархия</a>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Участки -->
    <div class="col-lg-4">
      <h3>Участки</h3>
      <table id="units-table" class="table table-striped">
        <thead>
          <tr><th>№</th><th>Название</th><th>Фабрика</th></tr>
        </thead>
        <tbody>
          {% for u in units %}
            <tr>
              <td>{{ forloop.counter }}</td>
              <td>
                <a href="{% url 'hierarchy' 'unit' u.id %}">{{ u.name }}</a>
              </td>
              <td>{{ u.factory.name }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Оборудование -->
    <div class="col-lg-4">
      <h3>Оборудование</h3>
      <table id="equipment-table" class="table table-striped">
        <thead>
          <tr><th>№</th><th>Название</th><th>Участки</th><th>Фабрики</th></tr>
        </thead>
        <tbody>
          {% for eq in equipment_data %}
            <tr>
              <td>{{ forloop.counter }}</td>
              <td>
                <a href="{% url 'hierarchy' 'equipment' eq.id %}">
                  {{ eq.name }}
                </a>
              </td>
              <td>
                {% for u in eq.units %}
                  <span class="badge bg-secondary me-1">{{ u.name }}</span>
                {% endfor %}
              </td>
              <td>
                {% for f in eq.factories %}
                  <span class="badge bg-info text-dark me-1">{{ f.name }}</span>
                {% endfor %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // CSRF helper
  function getCookie(n) {
    let v = null;
    document.cookie.split(';').forEach(c => {
      const [k,val] = c.trim().split('=');
      if (k === n) v = decodeURIComponent(val);
    });
    return v;
  }
  const csrftoken = getCookie('csrftoken');

  // POST JSON
  async function postJSON(url,data) {
    const r = await fetch(url,{
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        'X-CSRFToken':csrftoken
      },
      body: JSON.stringify(data)
    });
    if(!r.ok) throw new Error(r.status);
    return r.json();
  }

  // Renumber first cell in each row of given selector
  function renumber(selector) {
    document.querySelectorAll(selector).forEach((tr,i) => {
      tr.cells[0].textContent = i+1;
    });
  }

  // Sort and renumber units table
  function sortUnits() {
    const tb = document.querySelector('#units-table tbody');
    Array.from(tb.rows)
      .sort((a,b) => {
        const fa=a.cells[2].textContent.toLowerCase();
        const fb=b.cells[2].textContent.toLowerCase();
        if(fa!==fb) return fa.localeCompare(fb);
        return a.cells[1].textContent.toLowerCase()
               .localeCompare(b.cells[1].textContent.toLowerCase());
      })
      .forEach(r=>tb.append(r));
    renumber('#units-table tbody tr');
  }

  // Sort and renumber equipment table
  function sortEquipment() {
    const tb = document.querySelector('#equipment-table tbody');
    Array.from(tb.rows)
      .sort((a,b) => {
        const af = Array.from(a.cells[3].querySelectorAll('span'))
          .map(x=>x.textContent.toLowerCase()).join(',');
        const bf = Array.from(b.cells[3].querySelectorAll('span'))
          .map(x=>x.textContent.toLowerCase()).join(',');
        if(af!==bf) return af.localeCompare(bf);
        return a.cells[1].textContent.toLowerCase()
               .localeCompare(b.cells[1].textContent.toLowerCase());
      })
      .forEach(r=>tb.append(r));
    renumber('#equipment-table tbody tr');
  }

  // === Add Factory ===
  function addFactory(f) {
    document.querySelector('#factories-table tbody')
      .insertAdjacentHTML('beforeend', `
        <tr>
          <td>${f.id}</td>
          <td>${f.name}</td>
          <td>
            <a href="/hierarchy/factory/${f.id}/"
               class="btn btn-sm btn-outline-primary">
              Иерархия
            </a>
          </td>
        </tr>
      `);
    const sel = document.querySelector('#add-unit-form select[name="factory"]');
    sel.insertAdjacentHTML('beforeend',
      `<option value="${f.id}">${f.name}</option>`
    );
  }

  // === Add Unit ===
  function addUnit(u) {
    const selF = document.querySelector('#add-unit-form select[name="factory"]');
    const factName = selF.options[selF.selectedIndex].text;
    document.querySelector('#units-table tbody')
      .insertAdjacentHTML('beforeend', `
        <tr>
          <td>0</td>
          <td><a href="/hierarchy/unit/${u.id}/">${u.name}</a></td>
          <td>${factName}</td>
        </tr>
      `);
    // update equipment select
    document.querySelector('#add-equipment-form select[name="units"]')
      .insertAdjacentHTML('beforeend',
        `<option value="${u.id}">${factName} → ${u.name}</option>`
      );
    sortUnits();
  }

  // === Add Equipment ===
  function addEquipment(eq) {
    const opts = Array.from(
      document.querySelectorAll('#add-equipment-form select[name="units"] option')
    ).filter(o=>eq.units.includes(o.value));

    const unitBadges = opts.map(o=>{
      const n=o.textContent.split(' → ')[1];
      return `<span class="badge bg-secondary me-1">${n}</span>`;
    }).join('');

    const factories = Array.from(new Set(
      opts.map(o=>o.textContent.split(' → ')[0])
    ));
    const factBadges = factories.map(n=>
      `<span class="badge bg-info text-dark me-1">${n}</span>`
    ).join('');

    document.querySelector('#equipment-table tbody')
      .insertAdjacentHTML('beforeend', `
        <tr>
          <td>0</td>
          <td><a href="/hierarchy/equipment/${eq.id}/">${eq.name}</a></td>
          <td>${unitBadges}</td>
          <td>${factBadges}</td>
        </tr>
      `);
    sortEquipment();
  }

  // Initialize sort order
  sortUnits();
  sortEquipment();

  // === Event listeners ===

  document.getElementById('add-factory-form')
    .addEventListener('submit', async e => {
      e.preventDefault();
      const name = e.target.name.value.trim();
      if(!name) return;
      const f = await postJSON('/api/factories/', { name });
      addFactory(f);
      e.target.reset();
    });

  document.getElementById('add-unit-form')
    .addEventListener('submit', async e => {
      e.preventDefault();
      const name = e.target.name.value.trim();
      const factory = e.target.factory.value;
      if(!name||!factory) return;
      const u = await postJSON('/api/units/', { name, factory });
      addUnit(u);
      e.target.reset();
    });

  document.getElementById('add-equipment-form')
    .addEventListener('submit', async e => {
      e.preventDefault();
      const name = e.target.name.value.trim();
      const opts = Array.from(e.target.units.selectedOptions);
      if(!name||!opts.length) return;
      const units = opts.map(o=>o.value);
      const eq = await postJSON('/api/equipment/', { name, units });
      eq.units = units;
      addEquipment(eq);
      e.target.reset();
    });

});
</script>
{% endblock %}
